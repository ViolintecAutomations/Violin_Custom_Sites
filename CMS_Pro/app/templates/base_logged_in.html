{% extends 'base.html' %}
{% block content %}
<style>
  body {
    overflow-x: hidden;
  }
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    width: 280px;
    background: #bbdefb;
    border-right: 1px solid #1565c0;
    z-index: 2000;
    padding-top: 1rem;
    transition: width 0.3s cubic-bezier(.4,0,.2,1), transform 0.3s cubic-bezier(.4,0,.2,1);
    display: flex;
    flex-direction: column;
  }
  .sidebar.collapsed {
    width: 60px;
  }
  .sidebar-header {
    margin-bottom: 2rem;
    transition: opacity 0.3s;
    white-space: nowrap;
    color: #1976d2 !important;
  }
  .sidebar.collapsed .sidebar-header .fs-4,
  .sidebar.collapsed .sidebar-header .text-muted {
    opacity: 0;
    pointer-events: none;
  }
  .main-content {
    margin-left: 280px;
    padding: 2rem 2rem 2rem 2rem;
    transition: margin-left 0.3s cubic-bezier(.4,0,.2,1);
  }
  .sidebar.collapsed ~ .main-content {
    margin-left: 60px;
  }
  .main-content.full {
    margin-left: 60px;
  }
  .sidebar .nav {
    flex-direction: column;
    height: 100%;
    display: flex;
  }
  .sidebar .nav-item {
    flex: 0 0 auto;
    display: flex;
    align-items: center;
  }
  .sidebar .nav-link {
    display: flex;
    align-items: center;
    width: 100%;
    color: #1976d2 !important;
    background: transparent;
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
    font-weight: 500;
    box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    transition: background 0.2s, box-shadow 0.2s, color 0.2s, padding 0.3s;
    padding: 0.75rem 1rem;
  }
  .sidebar .nav-link .menu-icon {
    min-width: 28px;
    text-align: center;
    display: inline-block;
    font-size: 1.3rem;
  }
  .sidebar .nav-link .menu-label {
    margin-left: 12px;
    white-space: nowrap;
    transition: opacity 0.3s, width 0.3s;
    opacity: 1;
    width: auto;
    display: inline-block;
    font-weight: 700;
  }
  .sidebar.collapsed .nav-link .menu-label {
    opacity: 0;
    width: 0;
    pointer-events: none;
  }
  .sidebar .nav-link.active, .sidebar .nav-link:focus, .sidebar .nav-link:hover {
    background: #90caf9;
    color: #1976d2 !important;
    box-shadow: 0 6px 24px rgba(33,150,243,0.18);
  }
  .sidebar .nav-link.text-danger {
    color: #fff !important;
  }
  .hamburger {
    position: fixed;
    top: 18px;
    left: 18px;
    z-index: 2100;
    background: #1976d2;
    border: none;
    color: #fff;
    font-size: 1.5rem;
    border-radius: 0.375rem;
    padding: 0.25rem 0.5rem;
    display: none;
  }
  
  .back-btn {
    position: fixed;
    top: 16px;
    right: 16px;
    z-index: 2100;
    background: #6c757d;
    border: none;
    color: #fff;
    font-size: 1rem !important;
    border-radius: 50%;
    padding: 0.3rem 0.5rem !important;
    width: 32px !important;
    height: 32px !important;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  
  .back-btn:hover {
    background: #5a6268;
    transform: translateX(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  /* Mobile Responsiveness */
  @media (max-width: 1199.98px) {
    .sidebar {
      width: 250px;
    }
    .main-content {
      margin-left: 250px;
      padding: 1.5rem;
    }
    .sidebar.collapsed ~ .main-content {
      margin-left: 50px;
    }
  }

  @media (max-width: 991.98px) {
    .sidebar {
      position: fixed;
      width: 280px;
      height: 100vh;
      border-right: 1px solid #1565c0;
      left: 0;
      top: 0;
      background: #1976d2;
      transform: translateX(-100%);
      z-index: 2000;
    }
    .sidebar.show {
      transform: translateX(0);
    }
    .sidebar.collapsed {
      width: 60px;
    }
    .main-content {
      margin-left: 0;
      padding: 1rem;
    }
    .main-content.full {
      margin-left: 0;
    }
    .hamburger {
      display: block;
    }
    body.sidebar-open {
      overflow: hidden;
    }
    .sidebar-header .fs-4 {
      font-size: 1.2rem !important;
    }
    .sidebar .nav-link {
      padding: 0.6rem 0.8rem;
      font-size: 0.95rem;
    }
    .sidebar .nav-link .menu-icon {
      font-size: 1.1rem;
    }
    .hamburger {
      font-size: 1rem !important;
      padding: 0.15rem 0.3rem !important;
      width: 28px !important;
      height: 28px !important;
    }
    .back-btn {
      font-size: 0.9rem !important;
      padding: 0.2rem 0.4rem !important;
      width: 28px !important;
      height: 28px !important;
    }
  }

  @media (max-width: 767.98px) {
    .main-content {
      padding: 0.75rem;
    }
    .hamburger {
      top: 12px;
      left: 12px;
      font-size: 0.9rem !important;
      padding: 0.1rem 0.2rem !important;
      width: 24px !important;
      height: 24px !important;
    }
    .back-btn {
      top: 12px;
      right: 12px;
      font-size: 0.8rem !important;
      padding: 0.1rem 0.2rem !important;
      width: 24px !important;
      height: 24px !important;
    }
    .sidebar {
      width: 260px;
    }
    .sidebar-header {
      margin-bottom: 1.5rem;
    }
    .sidebar-header .fs-4 {
      font-size: 1.1rem !important;
    }
    .sidebar .nav-link {
      padding: 0.5rem 0.7rem;
      font-size: 0.9rem;
    }
  }

  @media (max-width: 575.98px) {
    .sidebar {
      width: 100vw;
      left: 0;
      top: 0;
      height: 100vh;
      border-radius: 0;
      padding-top: 0.5rem;
      min-width: 0;
    }
    .main-content {
      margin-left: 0;
      padding: 0.5rem;
      min-width: 0;
    }
    .sidebar-header .fs-4 {
      font-size: 1rem !important;
    }
    .sidebar-header img {
      max-width: 60px;
      max-height: 60px;
    }
    .sidebar .nav-link {
      padding: 0.5rem 0.6rem;
      font-size: 0.9rem;
    }
    .sidebar .nav-link .menu-icon {
      font-size: 1rem;
    }
    .hamburger {
      top: 8px;
      left: 8px;
      font-size: 0.8rem !important;
      padding: 0.1rem 0.2rem !important;
      width: 22px !important;
      height: 22px !important;
    }
    .back-btn {
      font-size: 0.8rem !important;
      padding: 0.15rem 0.3rem !important;
      width: 22px !important;
      height: 22px !important;
    }
  }
</style>
<button class="hamburger" id="sidebarToggle" aria-label="Toggle sidebar">
  <i class="bi bi-list"></i>
</button>
<div class="d-flex justify-content-end align-items-center" style="position: fixed; top: 16px; right: 16px; z-index: 2100; gap: 1rem;">
    <i class="bi bi-box-arrow-right"></i>
  </button>
</div>
<div class="sidebar" id="sidebar">
  <div class="sidebar-header text-center mb-4" style="color: #fff;">
    <img src="{{ url_for('static', filename='VT_Logo.png') }}" alt="VT Logo" style="max-width: 120px; max-height: 120px; margin-bottom: 0.5rem;">
    <div class="fs-4 fw-bold">Violin Technology</div>
    <div class="fs-4 fw-bold">CMS</div>
    <div class="text-muted small mt-2" style="color: #111 !important;">Current User : {{ current_user.name }}</div>
  </div>
  <ul class="nav flex-column">
    {% if current_user.role == 'Admin' %}
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('admin.dashboard') }}"><span class="menu-icon"><i class="bi bi-speedometer2"></i></span><span class="menu-label">Dashboard</span></a></li>
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('admin.add_user') }}"><span class="menu-icon"><i class="bi bi-person-plus"></i></span><span class="menu-label">Add User</span></a></li>
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('admin.employee_reports') }}"><span class="menu-icon"><i class="bi bi-people"></i></span><span class="menu-label">Employee Reports</span></a></li>
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('admin.dept_location_reports') }}"><span class="menu-icon"><i class="bi bi-building"></i></span><span class="menu-label">Dept/Location Reports</span></a></li>
      {% if current_user.role == 'Admin' and current_user.location and current_user.employee_id != 'a001' %}
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('admin.add_menu') }}"><span class="menu-icon"><i class="bi bi-plus-circle"></i></span><span class="menu-label">Add Menu</span></a></li>
      {% endif %}
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('admin.vendor_report_unit_wise') }}"><span class="menu-icon"><i class="bi bi-truck"></i></span><span class="menu-label">Outsider Meal Report</span></a></li>
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('admin.vendor_report') }}"><span class="menu-icon"><i class="bi bi-file-text"></i></span><span class="menu-label">Vendor Report</span></a></li>
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('admin.export') }}"><span class="menu-icon"><i class="bi bi-file-earmark-arrow-down"></i></span><span class="menu-label">Export</span></a></li>
      {% if current_user.employee_id == 'a001' %}
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('admin.cost_subsidy') }}"><span class="menu-icon"><i class="bi bi-cash-coin"></i></span><span class="menu-label">Cost & Subsidy</span></a></li>
      {% endif %}
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('employee.profile') }}"><span class="menu-icon"><i class="bi bi-person"></i></span><span class="menu-label">Profile</span></a></li>
      <li class="nav-item mt-2"><a class="nav-link d-flex align-items-center" href="{{ url_for('admin.logout') }}"><span class="menu-icon"><i class="bi bi-box-arrow-right"></i></span><span class="menu-label">{{ _('Logout') }}</span></a></li>
    {% elif current_user.role == 'Accounts' or (current_user.role == 'Admin' and current_user.department and current_user.department|lower == 'finance') %}
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('admin.dashboard') }}"><span class="menu-icon"><i class="bi bi-speedometer2"></i></span><span class="menu-label">Dashboard</span></a></li>
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('admin.cost_subsidy') }}"><span class="menu-icon"><i class="bi bi-cash-coin"></i></span><span class="menu-label">Cost & Subsidy</span></a></li>
      <li class="nav-item mt-2"><a class="nav-link d-flex align-items-center" href="{{ url_for('admin.logout') }}"><span class="menu-icon"><i class="bi bi-box-arrow-right"></i></span><span class="menu-label">{{ _('Logout') }}</span></a></li>
    {% elif current_user.role == 'Employee' %}
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('employee.dashboard') }}"><span class="menu-icon"><i class="bi bi-speedometer2"></i></span><span class="menu-label">Dashboard</span></a></li>
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('employee.book_meal') }}"><span class="menu-icon"><i class="bi bi-calendar-plus"></i></span><span class="menu-label">Book Meal</span></a></li>
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('employee.booking_history') }}"><span class="menu-icon"><i class="bi bi-journal-text"></i></span><span class="menu-label">My Bookings</span></a></li>
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('employee.view_menu') }}"><span class="menu-icon"><i class="bi bi-card-list"></i></span><span class="menu-label">Today's Meal</span></a></li>
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('employee.profile') }}"><span class="menu-icon"><i class="bi bi-person"></i></span><span class="menu-label">Profile</span></a></li>
      <li class="nav-item mt-2"><a class="nav-link d-flex align-items-center" href="{{ url_for('employee.logout') }}"><span class="menu-icon"><i class="bi bi-box-arrow-right"></i></span><span class="menu-label">{{ _('Logout') }}</span></a></li>
    {% elif current_user.role in ['Staff', 'Supervisor'] %}
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('staff.dashboard') }}"><span class="menu-icon"><i class="bi bi-speedometer2"></i></span><span class="menu-label">Dashboard</span></a></li>
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('staff.qr_scanner') }}"><span class="menu-icon"><i class="bi bi-upc-scan"></i></span><span class="menu-label">QR Scanner</span></a></li>
      <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('staff.summary') }}"><span class="menu-icon"><i class="bi bi-clipboard-data"></i></span><span class="menu-label">Daily Summary</span></a></li>
      {% if current_user.role == 'Supervisor' %}
        <li class="nav-item"><a class="nav-link d-flex align-items-center" href="{{ url_for('staff.manage_roles') }}"><span class="menu-icon"><i class="bi bi-person-gear"></i></span><span class="menu-label">Role Management</span></a></li>
      {% endif %}
      <li class="nav-item mt-2"><a class="nav-link d-flex align-items-center" href="{{ url_for('staff.logout') }}"><span class="menu-icon"><i class="bi bi-box-arrow-right"></i></span><span class="menu-label">{{ _('Logout') }}</span></a></li>
    {% endif %}
  </ul>
  <div class="sidebar-menu-section mt-auto p-3">
    {% block sidebar_menu %}{% endblock %}
  </div>
</div>
<main class="main-content d-flex justify-content-center align-items-center" id="mainContent" style="min-height: 80vh;">
  {% block main_content %}{% endblock %}
</main>
<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<script>
  const sidebar = document.getElementById('sidebar');
  const sidebarToggle = document.getElementById('sidebarToggle');
  const mainContent = document.getElementById('mainContent');
  function toggleSidebar() {
    if (window.innerWidth <= 991.98) {
      sidebar.classList.toggle('show');
      document.body.classList.toggle('sidebar-open');
      mainContent.classList.toggle('full');
    } else {
      sidebar.classList.toggle('collapsed');
      mainContent.classList.toggle('full');
    }
  }
  sidebarToggle.addEventListener('click', toggleSidebar);
  // Close sidebar when clicking outside on mobile
  document.addEventListener('click', function(event) {
    if (window.innerWidth <= 991.98 && sidebar.classList.contains('show')) {
      if (!sidebar.contains(event.target) && !sidebarToggle.contains(event.target)) {
        sidebar.classList.remove('show');
        document.body.classList.remove('sidebar-open');
        mainContent.classList.remove('full');
      }
    }
  });
  // Hide sidebar by default on mobile
  window.addEventListener('DOMContentLoaded', function() {
    if (window.innerWidth <= 991.98) {
      sidebar.classList.remove('show');
      mainContent.classList.add('full');
    }
  });
  // Handle window resize
  window.addEventListener('resize', function() {
    if (window.innerWidth > 991.98) {
      sidebar.classList.remove('show');
      document.body.classList.remove('sidebar-open');
    }
  });
</script>
<div id="js-data-container"
    data-initial-selected-unit-id="{{ selected_unit_id | default('null') | tojson }}"

    data-select-unit-url="{{ url_for('employee.select_unit') }}"
    data-get-menu-for-location-url-base="{{ url_for('employee.get_menu_for_location', location_id=0) }}"
    style="display: none;">
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const jsDataEl = document.getElementById('js-data-container');
    if (!jsDataEl) return;

    const initialSelectedUnitId = JSON.parse(jsDataEl.dataset.initialSelectedUnitId);
    const selectUnitUrl = jsDataEl.dataset.selectUnitUrl;
    const getMenuForLocationUrlBase = jsDataEl.dataset.getMenuForLocationUrlBase;

    const unitSelect = document.getElementById('unitSelect');
    const selectUnitBtn = document.getElementById('selectUnitBtn');
    const todaysMenuContent = document.getElementById('todaysMenuContent');
    const selectedUnitNameDisplay = document.getElementById('selectedUnitNameDisplay');
    
    const unitSelectionModalEl = document.getElementById('unitSelectionModal');
    let unitSelectionModal;
    if (unitSelectionModalEl) {
        unitSelectionModal = new bootstrap.Modal(unitSelectionModalEl, {
            backdrop: 'static',
            keyboard: false
        });
    }

    const modalUnitSelect = document.getElementById('modalUnitSelect');
    const modalSelectUnitBtn = document.getElementById('modalSelectUnitBtn');

    if (unitSelectionModal && (initialSelectedUnitId === null || typeof initialSelectedUnitId === 'undefined')) {
        unitSelectionModal.show();
    }

    if (selectUnitBtn && unitSelect) {
        selectUnitBtn.addEventListener('click', function() {
            const selectedUnitId = unitSelect.value;
            const selectedUnitName = unitSelect.options[unitSelect.selectedIndex].text;
            updateUnitAndMenu(selectedUnitId, selectedUnitName);
        });
    }

    if (modalSelectUnitBtn && modalUnitSelect) {
        modalSelectUnitBtn.addEventListener('click', function() {
            const selectedUnitId = modalUnitSelect.value;
            const selectedUnitName = modalUnitSelect.options[modalUnitSelect.selectedIndex].text;
            updateUnitAndMenu(selectedUnitId, selectedUnitName);
            if (unitSelectionModal) {
                unitSelectionModal.hide();
            }
        });
    }

    function updateUnitAndMenu(unitId, unitName) {
        if (!selectUnitUrl || !getMenuForLocationUrlBase) return;

        fetch(selectUnitUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'unit_id=' + unitId
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                if (selectedUnitNameDisplay) {
                    selectedUnitNameDisplay.textContent = unitName;
                }
                fetch(getMenuForLocationUrlBase.replace('0', unitId))
                    .then(response => response.json())
                    .then(menuData => {
                        let menuHtml = '';
                        if (menuData.menu && menuData.menu.length > 0) {
                            menuHtml = '<ul class="list-group list-group-flush">';
                            menuData.menu.forEach(function(menu) {
                                menuHtml += '<li class="list-group-item"><strong class="text-primary">' + menu.meal_type + ':</strong> ' + menu.items + '</li>';
                            });
                            menuHtml += '</ul>';
                        } else {
                            menuHtml = '<p class="card-text text-center text-muted">No menu available for the selected unit today.</p>';
                        }
                        if (todaysMenuContent) {
                            todaysMenuContent.innerHTML = menuHtml;
                        }
                    })
                    .catch(function(error) {
                        console.error('Error fetching menu:', error);
                        if (todaysMenuContent) {
                            todaysMenuContent.innerHTML = '<p class="card-text text-center text-danger">Error loading menu.</p>';
                        }
                    });
            } else {
                console.error('Error saving unit selection:', data.message);
                alert('Failed to save unit selection: ' + data.message);
            }
        })
        .catch(function(error) {
            console.error('Network error or unexpected response:', error);
            alert('An unexpected error occurred while saving unit selection.');
        });
    }
});
</script>
{% endblock %}